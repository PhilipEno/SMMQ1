<!DOCTYPE html>
<html>
<script>
	//youtube start shizzle
	var yttag = document.createElement('script');
	yttag.src = "https://www.youtube.com/iframe_api";
	var firstScriptTag = document.getElementsByTagName('script')[0];
	firstScriptTag.parentNode.insertBefore(yttag, firstScriptTag);
    
	//global vars
	var answertimer;
	var pausetimer;
	var mediaplayer;
	var artisttags = []; //array of tags for artist name
    var titletags =  []; //array of tags for song title 
	var artisttagsfound = []; 
    var titletagsfound  = [];
	var timeleft;
    
	//function that loads on window start
	window.onload = function()
	{
		newPuzzle();
	};
    
	//function required by youtube api
	function onYouTubeIframeAPIReady() 
	{
	}
    
	//start a new puzzle
	function newPuzzle() 
	{
		timeleft = 15000;
		document.getElementById("yougotit").style.visibility = "hidden";
        
		//load all songs and select a random song
		var rawFile = new XMLHttpRequest();			
		rawFile.open("GET", "https://frankvdg.github.io/SMMQ1/playlist.txt", false);
		rawFile.onreadystatechange = function() 
		{
			if(rawFile.readyState === 4) 
			{
				if(rawFile.status === 200 || rawFile.status == 0) 
				{
					var allText = rawFile.responseText;
					var songdata = allText.split('\n');
					var numsongs = songdata.length / 4;
					var randomselect = Math.floor((Math.random() * numsongs) + 0);
					url  = songdata[randomselect*4 + 0];
                   
                    artisttags = [];
                    artisttags = artisttags.concat ((songdata[randomselect*4 + 1]).toLowerCase().split(' '));
					
                    titletags = [];
                    titletags = titletags.concat ((songdata[randomselect*4 + 2]).toLowerCase().split(' '));
                    
                    artisttagsfound = [];
                    var numartisttags = artisttags.length;
                    for (var i=0; i<numartisttags; i++) 
        			{
                    	artisttags[i] = artisttags[i].trim();   //remove whites from start and end
                        artisttagsfound.push (false);
                    }
                    
                    titletagsfound = [];
                    var numtitletags = titletags.length;
                    for (var i=0; i<numtitletags; i++) 
        			{
                    	titletags[i] = titletags[i].trim();   //remove whites from start and end
                        titletagsfound.push (false);
                    }
                    
					mediaplayer = new YT.Player('mediaplayer', {
							height: '390',
							width: '640',
							videoId: url,	
							playerVars: {
							autoplay: 0,
							controls: 0,
							disablekb: 1,
							hl: 'ru-ru',
							loop: 0,
							showinfo: 0,
							autohide: 1,
							rel: 0
						},
						events: {
							'onReady': onPlayerReady,
							'onStateChange': onPlayerStateChange
						}
					});
				}
    		}
		}
		rawFile.send(null);		            
	}
	
	//called when youtube player has song loaded
	function onPlayerReady(event) 
	{         
		mediaplayer.playVideo();

		//start song in random position
		var randomseekto = Math.floor((Math.random() * 80) + 20);
		mediaplayer.seekTo(randomseekto);

		startAnswerTimer();
        updateVisibleAnswerTags();
	}
	
	//suggest an answer from the textarea
	function giveAnswer() 
	{
		var currenttext = document.getElementById('textarea0').value;
        currenttext = currenttext.toLowerCase().trim();
        
		var numartisttags = artisttags.length;
        for (var i=0; i<numartisttags; i++) 
        {
			if (artisttagsfound[i] == false)
			{
				if (currenttext == artisttags[i]) 
				{
					artisttagsfound[i] = true;
					updateVisibleAnswerTags();
					document.getElementById('textarea0').value = "";
                    
                    if (checkAnswerTagsAllFound())
					{		
						document.getElementById("yougotit").innerHTML = "YOU GOT IT!";
						document.getElementById("yougotit").style.visibility = "visible";
					}
                    return;
				}
			}      
        }
        
        var numtitletags = titletags.length;
        for (var i=0; i<numtitletags; i++) 
        {
			if (titletagsfound[i] == false)
			{
				if (currenttext == titletags[i]) 
				{
					titletagsfound[i] = true;
					updateVisibleAnswerTags();
					document.getElementById('textarea0').value = "";
                    
                    if (checkAnswerTagsAllFound())
					{		
						document.getElementById("yougotit").innerHTML = "YOU GOT IT!";
						document.getElementById("yougotit").style.visibility = "visible";
					}
                    return;
				}
			}      
        }
	}
	
    //checks if all tags have been found
    function checkAnswerTagsAllFound()
    {
        var numartisttags = artisttags.length;
        for (var i=0; i<numartisttags; i++) 
        {
        	if (artisttagsfound[i] == false)
            {
            	return false;
            }
        }
        var numtitletags = titletags.length;
        for (var i=0; i<numtitletags; i++) 
        {
        	if (titletagsfound[i] == false)
            {
            	return false;
            }
        }
        return true;
    }
    
	//show all found tags in answertable
	function updateVisibleAnswerTags() 
	{
		var text = "";
        var numartisttags = artisttags.length;
        for (var i=0; i<numartisttags; i++) 
        {
        	if (artisttagsfound[i] == true)
            {
            	text += artisttags[i];
                text += " ";
            }
        }
        document.getElementById("answerartisttags").innerHTML = text;
        
        text = "";
        var numtitletags = titletags.length;
        for (var i=0; i<numtitletags; i++) 
        {
        	if (titletagsfound[i] == true)
            {
            	text += titletags[i];
                text += " ";
            }
        }
        document.getElementById("answertitletags").innerHTML = text;
	}
	
	//start the timer for answering period
	function startAnswerTimer() 
	{
		answertimer = setInterval(answerTimerInterval, 10);
		function answerTimerInterval() 
		{
			if (timeleft > 0) 
			{
				timeleft-=10; 
		  		progressbar.value = timeleft;
           	} else {
		  		clearInterval(answertimer);
				mediaplayer.stopVideo();
				mediaplayer.destroy();
				pausetimer = setTimeout(reachedPauseEnd, 2000);
			
           		if (!checkAnswerTagsAllFound())
           		{	
					document.getElementById("yougotit").innerHTML = "YOU FAILED!";	
					document.getElementById("yougotit").style.visibility = "visible";
				}
			}
		}
	}
	
	//called when 2 sec pause between songs ends
	function reachedPauseEnd()
	{
		newPuzzle();
	}
	
	//required by youtube?
	function onPlayerStateChange(event) 
	{
	}
</script>









<style>
body {
	background-color: #CDC5B0;
}
h1 {
	color: black;
	text-align: center;
	font-family: verdana;
}
p {
	text-align: center;
	font-family: verdana;
	font-size: 20px;
}
.container {
	position: absolute;
	top: 50%;
	left: 50%;
	-moz-transform: translateX(-50%) translateY(-50%);
	-webkit-transform: translateX(-50%) translateY(-50%);
	transform: translateX(-50%) translateY(-50%);
}
table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 400px;
}
td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
    //background-color: #dddddd;
}
th {
    border: 1px solid #dddddd;
    text-align: right;
    padding: 8px;
    background-color: #dddddd;
}
</style>


	
	

<body>
	<div align="center">
		<form action="index.html">
			<input type="submit" value="GO BACK" />
		</form>

		<p><div id="mediaplayer" style="width:0;height:0;border:0; border:none;"></div></p>

        <progress id="progressbar" value="15000" max="15000">
		</progress>

		<p><textarea rows="4" cols="50" id="textarea0" oninput="giveAnswer()"></textarea></p>

		<font size=40 id="yougotit" style="visibility:hidden;">YOU GOT IT!</font>

		<table class="fixed">
    		<col width="50px" />
    		<col width="100px" />
			<tr>
				<th>Artist</th>
				<td id="answerartisttags"> </td>
			</tr>
			<tr>
  				<th>Title</th>
    			<td id="answertitletags"> </td>
			</tr>
		</table>


	</div>
</body>
</html>
